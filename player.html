<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>视频播放 - 字幕播放器</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #header {
    background: #1a1a1a;
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 100;
  }
  #back-button {
    background: #1890ff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  #back-button:hover { background: #0050b3; }
  #video-title {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0;
    flex: 1;
    text-align: center;
    padding: 0 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #subtitle-controls { display: flex; align-items: center; gap: 15px; }
  #subtitle-toggle {
    background: #52c41a;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  #subtitle-toggle:hover { background: #389e0d; }
  #subtitle-toggle.disabled { background: #666; cursor: not-allowed; }
  #subtitle-status { font-size: 12px; color: #999; }
  #video-container {
    flex: 1;
    position: relative;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #youtube-player, #fallback-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  #subtitle-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 50;
  }
  .subtitle-line {
    color: #fff;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    font-size: 20px;
    font-weight: 500;
    white-space: pre-wrap;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    position: absolute;
  }
  #loading, #error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  #error { background: #ff4d4f; padding: 20px; border-radius: 6px; }
  .hidden { display: none !important; }
  .fallback-notice {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 193, 7, 0.9);
    color: #000;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 60;
  }
</style>
</head>
<body>

<div id="header">
  <a href="index.html" id="back-button">← 返回列表</a>
  <h1 id="video-title">加载中...</h1>
  <div id="subtitle-controls">
    <span id="subtitle-status">字幕: 加载中...</span>
    <button id="subtitle-toggle" class="disabled">显示字幕</button>
  </div>
</div>

<div id="video-container">
  <div id="loading">
    正在加载视频...<br>
    <small id="loading-status">初始化播放器</small>
  </div>
  <div id="error" class="hidden">
    <h3>加载失败</h3>
    <p>无法加载视频</p>
    <button onclick="retryLoad()" style="margin-top: 10px; padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">重试</button>
  </div>
  
  <iframe id="youtube-player" class="hidden" allowfullscreen></iframe>
  <iframe id="fallback-iframe" class="hidden" allowfullscreen></iframe>
  
  <div id="subtitle-overlay"></div>
</div>

<script>
let currentVideoId = '';
let subtitles = [];
let subtitlesVisible = true;
let player = null;
let updateInterval = null;
let loadingTimeout = null;
let usingFallback = false;

function getVideoIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('v');
}

// 改版: 保留标签
function parseASSSubtitles(assContent) {
  const lines = assContent.split('\n');
  const subtitleLines = [];
  let inEvents = false;
  for (let line of lines) {
    line = line.trim();
    if (line === '[Events]') { inEvents = true; continue; }
    if (line.startsWith('[') && line !== '[Events]') { inEvents = false; continue; }
    if (inEvents && line.startsWith('Dialogue:')) {
      const parts = line.split(',');
      if (parts.length >= 10) {
        const startTime = parseASSTime(parts[1]);
        const endTime = parseASSTime(parts[2]);
        const text = parts.slice(9).join(',').replace(/\\N/g, '\n').trim();
        if (text && startTime !== null && endTime !== null) {
          subtitleLines.push({ start: startTime, end: endTime, text });
        }
      }
    }
  }
  return subtitleLines.sort((a, b) => a.start - b.start);
}

function parseASSTime(timeStr) {
  const match = timeStr.match(/(\d+):(\d+):(\d+)\.(\d+)/);
  if (!match) return null;
  return parseInt(match[1]) * 3600 + parseInt(match[2]) * 60 + parseInt(match[3]) + parseInt(match[4]) / 100;
}

async function loadSubtitles(videoId) {
  try {
    const response = await fetch(`./subtitles/${videoId}.ass`);
    if (!response.ok) throw new Error('字幕文件不存在');
    const assContent = await response.text();
    subtitles = parseASSSubtitles(assContent);
    if (subtitles.length > 0) {
      document.getElementById('subtitle-status').textContent = `字幕: ${subtitles.length} 行`;
      document.getElementById('subtitle-toggle').classList.remove('disabled');
      document.getElementById('subtitle-toggle').textContent = '隐藏字幕';
      return true;
    } else throw new Error('字幕文件为空');
  } catch {
    document.getElementById('subtitle-status').textContent = '字幕: 无';
    document.getElementById('subtitle-toggle').classList.add('disabled');
    document.getElementById('subtitle-toggle').textContent = '无字幕';
    subtitles = [];
    subtitlesVisible = false;
    return false;
  }
}

// 改版: 渲染位置
function displayCurrentSubtitle(currentTime) {
  const overlay = document.getElementById('subtitle-overlay');
  overlay.innerHTML = '';
  if (!subtitlesVisible || subtitles.length === 0) return;
  const currentSub = subtitles.find(sub => currentTime >= sub.start && currentTime <= sub.end);
  if (currentSub) {
    currentSub.text.split('\n').forEach(line => {
      let style = '';
      const posMatch = line.match(/\\pos\((\d+),(\d+)\)/);
      const moveMatch = line.match(/\\move\((\d+),(\d+),(\d+),(\d+)\)/);
      const alignMatch = line.match(/\\an(\d)/);
      if (posMatch) style += `left:${posMatch[1]}px; top:${posMatch[2]}px;`;
      if (moveMatch) {
        style += `left:${moveMatch[1]}px; top:${moveMatch[2]}px; transition: all ${(currentSub.end - currentSub.start)}s linear;`;
        setTimeout(() => {
          const el = overlay.querySelector(`[data-sub="${line}"]`);
          if (el) {
            el.style.left = `${moveMatch[3]}px`;
            el.style.top = `${moveMatch[4]}px`;
          }
        }, 50);
      }
      if (alignMatch) {
        if (alignMatch[1] === '1') style += 'text-align:left;';
        if (alignMatch[1] === '2') style += 'text-align:center;';
        if (alignMatch[1] === '3') style += 'text-align:right;';
      }
      const cleanText = line.replace(/\{[^}]*\}/g, '');
      overlay.innerHTML += `<div class="subtitle-line" style="${style}" data-sub="${line}">${cleanText}</div>`;
    });
  }
}

async function fetchVideoTitle(videoId) {
  try {
    const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
    if (res.ok) {
      const data = await res.json();
      return data.title || '视频播放';
    }
  } catch {}
  return '视频播放';
}

function updateLoadingStatus(status) {
  const el = document.getElementById('loading-status');
  if (el) el.textContent = status;
}

function showSuccess() {
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('error').classList.add('hidden');
  if (usingFallback) {
    document.getElementById('fallback-iframe').classList.remove('hidden');
    const notice = document.createElement('div');
    notice.className = 'fallback-notice';
    notice.textContent = '使用备用播放器 - 字幕可能不完全同步';
    document.getElementById('video-container').appendChild(notice);
  } else {
    document.getElementById('youtube-player').classList.remove('hidden');
  }
  if (loadingTimeout) clearTimeout(loadingTimeout);
}

function onYouTubeIframeAPIReady() { if (currentVideoId) initializeYouTubePlayer(); }
function onPlayerReady() { showSuccess(); startSubtitleUpdate(); if (loadingTimeout) clearTimeout(loadingTimeout); }
function onPlayerStateChange(e) { if (e.data === 1) startSubtitleUpdate(); }
function onPlayerError() { tryFallbackPlayer(); }

// 改版: 5秒超时 fallback
function initializeYouTubePlayer() {
  try {
    updateLoadingStatus('创建YouTube播放器...');
    player = new YT.Player('youtube-player', {
      height: '100%', width: '100%', videoId: currentVideoId,
      playerVars: { 'playsinline': 1, 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1, 'fs': 1 },
      events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError }
    });
    loadingTimeout = setTimeout(() => { tryFallbackPlayer(); }, 5000);
  } catch { tryFallbackPlayer(); }
}

function tryFallbackPlayer() {
  if (usingFallback) return;
  usingFallback = true;
  updateLoadingStatus('使用备用播放器...');
  if (loadingTimeout) clearTimeout(loadingTimeout);
  const fb = document.getElementById('fallback-iframe');
  fb.src = `https://www.youtube.com/embed/${currentVideoId}?autoplay=1&controls=1&rel=0&modestbranding=1&fs=1`;
  fb.onload = () => { showSuccess(); startBasicSubtitleUpdate(); };
}

function startBasicSubtitleUpdate() {
  if (subtitles.length === 0) return;
  let startTime = Date.now();
  if (updateInterval) clearInterval(updateInterval);
  updateInterval = setInterval(() => {
    const elapsed = (Date.now() - startTime) / 1000;
    displayCurrentSubtitle(elapsed);
  }, 500);
}

function startSubtitleUpdate() {
  if (subtitles.length === 0) return;
  if (updateInterval) clearInterval(updateInterval);
  updateInterval = setInterval(() => {
    if (player && typeof player.getCurrentTime === 'function') {
      try { displayCurrentSubtitle(player.getCurrentTime()); } catch {}
    }
  }, 100);
}

function showError(message) {
  document.getElementById('error').innerHTML = `<h3>加载失败</h3><p>${message}</p>`;
  document.getElementById('error').classList.remove('hidden');
  document.getElementById('loading').classList.add('hidden');
}

function retryLoad() { location.reload(); }
function toggleSubtitles() {
  const btn = document.getElementById('subtitle-toggle');
  if (btn.classList.contains('disabled') || subtitles.length === 0) return;
  subtitlesVisible = !subtitlesVisible;
  btn.textContent = subtitlesVisible ? '隐藏字幕' : '显示字幕';
  if (!subtitlesVisible) document.getElementById('subtitle-overlay').innerHTML = '';
}

function loadYouTubeAPI() {
  return new Promise((resolve, reject) => {
    if (window.YT && window.YT.Player) { resolve(); return; }
    const script = document.createElement('script');
    script.src = 'https://www.youtube.com/iframe_api'; script.async = true;
    script.onload = () => {};
    script.onerror = () => reject(new Error('API加载失败'));
    document.head.appendChild(script);
    setTimeout(() => reject(new Error('API初始化超时')), 8000);
  });
}

async function initializePage() {
  try {
    currentVideoId = getVideoIdFromUrl();
    if (!currentVideoId) throw new Error('未提供视频ID');
    updateLoadingStatus('加载视频信息...');
    const [title] = await Promise.all([fetchVideoTitle(currentVideoId), loadSubtitles(currentVideoId)]);
    document.getElementById('video-title').textContent = title;
    document.title = `${title} - 视频播放`;
    updateLoadingStatus('加载YouTube API...');
    try { await loadYouTubeAPI(); } catch { setTimeout(() => tryFallbackPlayer(), 1000); }
  } catch (err) { showError(err.message); }
}

window.addEventListener('beforeunload', () => {
  if (updateInterval) clearInterval(updateInterval);
  if (loadingTimeout) clearTimeout(loadingTimeout);
  if (player && typeof player.destroy === 'function') { try { player.destroy(); } catch {} }
});

window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
document.addEventListener('DOMContentLoaded', () => {
  initializePage();
  document.getElementById('subtitle-toggle').addEventListener('click', toggleSubtitles);
  document.addEventListener('keydown', (e) => {
    if ((e.key === 's' || e.key === 'S') && subtitles.length > 0) { e.preventDefault(); toggleSubtitles(); }
    else if (e.key === 'Escape') { e.preventDefault(); window.location.href = 'index.html'; }
  });
});
</script>
</body>
</html>
