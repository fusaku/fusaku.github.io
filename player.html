<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>视频播放 - 字幕播放器</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  #header {
    background: #1a1a1a;
    padding: 15px 20px;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 100;
  }

  #back-button {
    background: #1890ff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  #back-button:hover {
    background: #0050b3;
  }

  #video-title {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0;
    flex: 1;
    text-align: center;
    padding: 0 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #subtitle-controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  #subtitle-toggle {
    background: #52c41a;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  #subtitle-toggle:hover {
    background: #389e0d;
  }

  #subtitle-toggle.disabled {
    background: #666;
    cursor: not-allowed;
  }

  #subtitle-status {
    font-size: 12px;
    color: #999;
  }

  #video-container {
    flex: 1;
    position: relative;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .video-player {
    width: 100%;
    height: 100%;
    border: none;
  }

  #subtitle-overlay {
    position: absolute;
    bottom: 80px;
    left: 0;
    right: 0;
    text-align: center;
    pointer-events: none;
    z-index: 50;
    padding: 0 40px;
  }

  .subtitle-line {
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 8px 16px;
    margin: 2px auto;
    border-radius: 4px;
    font-size: 20px;
    font-weight: 500;
    line-height: 1.4;
    max-width: 80%;
    word-wrap: break-word;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  #loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #999;
    font-size: 16px;
    text-align: center;
  }

  #error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ff4d4f;
    color: white;
    padding: 20px;
    border-radius: 6px;
    text-align: center;
    max-width: 500px;
  }

  .hidden {
    display: none !important;
  }

  .player-notice {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 193, 7, 0.95);
    color: #000;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 60;
    max-width: 90%;
    text-align: center;
  }

  .retry-section {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
  }

  .retry-button {
    padding: 8px 16px;
    background: #1890ff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .retry-button:hover {
    background: #0050b3;
  }

  .youtube-link {
    color: #ff4757;
    text-decoration: none;
    font-size: 14px;
  }

  .youtube-link:hover {
    text-decoration: underline;
  }

  /* 字幕特效样式 */
  .subtitle-line.fade-in {
    animation: subtitleFadeIn 0.3s ease-out;
  }

  .subtitle-line.fade-out {
    animation: subtitleFadeOut 0.3s ease-out;
  }

  @keyframes subtitleFadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes subtitleFadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    #header {
      padding: 10px 15px;
      flex-wrap: wrap;
    }

    #video-title {
      font-size: 16px;
      order: 3;
      width: 100%;
      text-align: left;
      margin-top: 10px;
    }

    #subtitle-overlay {
      bottom: 60px;
      padding: 0 20px;
    }

    .subtitle-line {
      font-size: 18px;
      padding: 6px 12px;
    }

    .player-notice {
      font-size: 11px;
      padding: 6px 12px;
    }
  }
</style>
</head>
<body>

<div id="header">
  <a href="index.html" id="back-button">
    ← 返回列表
  </a>
  <h1 id="video-title">加载中...</h1>
  <div id="subtitle-controls">
    <span id="subtitle-status">字幕: 加载中...</span>
    <button id="subtitle-toggle" class="disabled">显示字幕</button>
  </div>
</div>

<div id="video-container">
  <div id="loading">
    正在加载视频...<br>
    <small id="loading-status">检查视频可用性</small>
  </div>
  
  <div id="error" class="hidden">
    <h3>无法播放视频</h3>
    <p id="error-message">视频可能有嵌入限制</p>
    <div class="retry-section">
      <button class="retry-button" onclick="retryLoad()">重试加载</button>
      <a class="youtube-link" id="youtube-direct-link" target="_blank">
        在YouTube上观看
      </a>
    </div>
  </div>
  
  <iframe id="video-iframe" class="video-player hidden" allowfullscreen allow="autoplay"></iframe>
  
  <div id="subtitle-overlay"></div>
</div>

<script>
let currentVideoId = '';
let subtitles = [];
let subtitlesVisible = true;
let player = null;
let updateInterval = null;
let loadingTimeout = null;
let lastSubtitleText = '';
let playerType = 'none'; // 'api', 'embed', 'none'

// 从URL获取视频ID
function getVideoIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('v');
}

// ASS字幕解析器
function parseASSSubtitles(assContent) {
  const lines = assContent.split('\n');
  const subtitleLines = [];
  let inEvents = false;
  
  for (let line of lines) {
    line = line.trim();
    
    if (line === '[Events]') {
      inEvents = true;
      continue;
    }
    
    if (line.startsWith('[') && line !== '[Events]') {
      inEvents = false;
      continue;
    }
    
    if (inEvents && line.startsWith('Dialogue:')) {
      const parts = line.split(',');
      if (parts.length >= 10) {
        const startTime = parseASSTime(parts[1]);
        const endTime = parseASSTime(parts[2]);
        const text = parts.slice(9).join(',').replace(/\\N/g, '\n');
        
        const cleanText = text.replace(/\{[^}]*\}/g, '').trim();
        
        if (cleanText && startTime !== null && endTime !== null) {
          subtitleLines.push({
            start: startTime,
            end: endTime,
            text: cleanText
          });
        }
      }
    }
  }
  
  return subtitleLines.sort((a, b) => a.start - b.start);
}

// 解析ASS时间格式
function parseASSTime(timeStr) {
  const match = timeStr.match(/(\d+):(\d+):(\d+)\.(\d+)/);
  if (!match) return null;
  
  const hours = parseInt(match[1]);
  const minutes = parseInt(match[2]);
  const seconds = parseInt(match[3]);
  const centiseconds = parseInt(match[4]);
  
  return hours * 3600 + minutes * 60 + seconds + centiseconds / 100;
}

// 加载字幕文件
async function loadSubtitles(videoId) {
  try {
    const response = await fetch(`./subtitles/${videoId}.ass`);
    if (!response.ok) {
      throw new Error('字幕文件不存在');
    }
    
    const assContent = await response.text();
    subtitles = parseASSSubtitles(assContent);
    
    if (subtitles.length > 0) {
      document.getElementById('subtitle-status').textContent = `字幕: ${subtitles.length} 行`;
      document.getElementById('subtitle-toggle').classList.remove('disabled');
      document.getElementById('subtitle-toggle').textContent = '隐藏字幕';
      console.log(`成功加载 ${subtitles.length} 行字幕`);
      return true;
    } else {
      throw new Error('字幕文件为空');
    }
  } catch (error) {
    console.warn('加载字幕失败:', error.message);
    document.getElementById('subtitle-status').textContent = '字幕: 无';
    document.getElementById('subtitle-toggle').classList.add('disabled');
    document.getElementById('subtitle-toggle').textContent = '无字幕';
    subtitles = [];
    subtitlesVisible = false;
    return false;
  }
}

// 获取YouTube视频标题
async function fetchVideoTitle(videoId) {
  try {
    const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
    if (response.ok) {
      const data = await response.json();
      return data.title || '视频播放';
    }
  } catch (error) {
    console.warn('无法获取视频标题:', error);
  }
  return '视频播放';
}

// 显示当前字幕（改进版，带动画效果）
function displayCurrentSubtitle(currentTime) {
  if (!subtitlesVisible || subtitles.length === 0) {
    const overlay = document.getElementById('subtitle-overlay');
    if (overlay.innerHTML !== '') {
      overlay.innerHTML = '';
    }
    return;
  }
  
  const currentSub = subtitles.find(sub => 
    currentTime >= sub.start && currentTime <= sub.end
  );
  
  const overlay = document.getElementById('subtitle-overlay');
  const newText = currentSub ? currentSub.text : '';
  
  // 只有字幕内容发生变化时才更新DOM
  if (newText !== lastSubtitleText) {
    if (newText) {
      const lines = newText.split('\n');
      overlay.innerHTML = lines
        .map(line => `<div class="subtitle-line fade-in">${line}</div>`)
        .join('');
    } else {
      // 添加淡出动画
      const existingLines = overlay.querySelectorAll('.subtitle-line');
      existingLines.forEach(line => line.classList.add('fade-out'));
      
      setTimeout(() => {
        overlay.innerHTML = '';
      }, 300);
    }
    lastSubtitleText = newText;
  }
}

// 更新加载状态
function updateLoadingStatus(status) {
  const loadingStatus = document.getElementById('loading-status');
  if (loadingStatus) {
    loadingStatus.textContent = status;
  }
}

// 显示成功状态
function showSuccess(type = 'unknown') {
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('error').classList.add('hidden');
  document.getElementById('video-iframe').classList.remove('hidden');
  
  // 显示播放器类型提示
  let noticeText = '';
  if (type === 'api') {
    noticeText = '使用YouTube API播放器 - 字幕精确同步';
    playerType = 'api';
  } else if (type === 'embed') {
    noticeText = '使用标准嵌入播放器 - 字幕时间估算';
    playerType = 'embed';
  }
  
  if (noticeText) {
    const notice = document.createElement('div');
    notice.className = 'player-notice';
    notice.textContent = noticeText;
    document.getElementById('video-container').appendChild(notice);
    
    // 5秒后隐藏提示
    setTimeout(() => {
      if (notice.parentNode) {
        notice.remove();
      }
    }, 5000);
  }
  
  // 清除超时
  if (loadingTimeout) {
    clearTimeout(loadingTimeout);
    loadingTimeout = null;
  }
  
  // 开始字幕更新
  startSubtitleUpdate();
}

// 显示错误
function showError(message, canRetry = true) {
  document.getElementById('error-message').textContent = message;
  document.getElementById('error').classList.remove('hidden');
  document.getElementById('loading').classList.add('hidden');
  
  // 设置YouTube直接链接
  const youtubeLink = document.getElementById('youtube-direct-link');
  youtubeLink.href = `https://www.youtube.com/watch?v=${currentVideoId}`;
  
  if (!canRetry) {
    document.querySelector('.retry-button').style.display = 'none';
  }
}

// YouTube Player API相关函数
function onYouTubeIframeAPIReady() {
  console.log('YouTube API 已准备就绪');
  if (currentVideoId) {
    initializeYouTubePlayer();
  }
}

function onPlayerReady(event) {
  console.log('YouTube API Player 已准备就绪');
  showSuccess('api');
}

function onPlayerStateChange(event) {
  if (event.data === 1 && playerType === 'api') { // Playing
    startSubtitleUpdate();
  }
}

function onPlayerError(event) {
  console.error('YouTube Player 错误:', event.data);
  let errorMessage = '';
  
  switch(event.data) {
    case 101:
    case 150:
      errorMessage = '该视频禁止在此网站播放（嵌入限制）';
      break;
    case 100:
      errorMessage = '视频不存在或已被删除';
      break;
    case 2:
      errorMessage = '视频ID无效';
      break;
    default:
      errorMessage = '视频播放出错';
  }
  
  console.log('API播放器失败，尝试标准嵌入');
  tryEmbedPlayer();
}

// 初始化YouTube API播放器
function initializeYouTubePlayer() {
  try {
    updateLoadingStatus('创建API播放器...');
    console.log('正在创建 YouTube API 播放器...');
    
    player = new YT.Player('video-iframe', {
      height: '100%',
      width: '100%',
      videoId: currentVideoId,
      playerVars: {
        'playsinline': 1,
        'autoplay': 1,
        'controls': 1,
        'rel': 0,
        'modestbranding': 1,
        'fs': 1,
        'enablejsapi': 1
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange,
        'onError': onPlayerError
      }
    });
    
    console.log('YouTube API 播放器创建成功');
    
    // 设置超时，如果6秒内没有ready就尝试嵌入播放器
    loadingTimeout = setTimeout(() => {
      console.warn('YouTube API播放器超时，尝试标准嵌入');
      tryEmbedPlayer();
    }, 6000);
    
  } catch (error) {
    console.error('创建API播放器时出错:', error);
    tryEmbedPlayer();
  }
}

// 尝试标准嵌入播放器
function tryEmbedPlayer() {
  if (playerType !== 'none') return; // 防止重复调用
  
  console.log('切换到标准嵌入播放器');
  updateLoadingStatus('使用标准嵌入播放器...');
  
  // 清除API相关的超时和播放器
  if (loadingTimeout) {
    clearTimeout(loadingTimeout);
    loadingTimeout = null;
  }
  
  if (player && typeof player.destroy === 'function') {
    try {
      player.destroy();
    } catch (e) {
      console.warn('销毁API播放器失败:', e);
    }
    player = null;
  }
  
  // 创建标准嵌入iframe
  const iframe = document.getElementById('video-iframe');
  const embedUrl = `https://www.youtube.com/embed/${currentVideoId}?autoplay=1&controls=1&rel=0&modestbranding=1&fs=1`;
  iframe.src = embedUrl;
  
  // 监听iframe加载
  iframe.onload = function() {
    console.log('标准嵌入播放器加载完成');
    showSuccess('embed');
  };
  
  iframe.onerror = function() {
    console.error('标准嵌入播放器也加载失败');
    showError('该视频无法在此页面播放，可能有嵌入限制');
  };
  
  // 3秒后强制显示（即使不确定是否成功）
  setTimeout(() => {
    if (playerType === 'none') {
      console.log('强制显示嵌入播放器');
      showSuccess('embed');
    }
  }, 3000);
}

// 启动字幕更新
function startSubtitleUpdate() {
  if (subtitles.length === 0) return;
  
  // 清除现有定时器
  if (updateInterval) {
    clearInterval(updateInterval);
    updateInterval = null;
  }
  
  if (playerType === 'api' && player && typeof player.getCurrentTime === 'function') {
    // API播放器：精确同步
    console.log('启动API播放器字幕同步');
    updateInterval = setInterval(() => {
      try {
        const currentTime = player.getCurrentTime();
        displayCurrentSubtitle(currentTime);
      } catch (e) {
        console.warn('获取播放时间失败:', e);
      }
    }, 100);
  } else {
    // 嵌入播放器：时间估算
    console.log('启动嵌入播放器字幕估算');
    let startTime = Date.now();
    
    updateInterval = setInterval(() => {
      const elapsedSeconds = (Date.now() - startTime) / 1000;
      displayCurrentSubtitle(elapsedSeconds);
    }, 500);
  }
}

// 切换字幕显示
function toggleSubtitles() {
  const toggleButton = document.getElementById('subtitle-toggle');
  
  if (toggleButton.classList.contains('disabled') || subtitles.length === 0) {
    return;
  }
  
  subtitlesVisible = !subtitlesVisible;
  toggleButton.textContent = subtitlesVisible ? '隐藏字幕' : '显示字幕';
  
  if (!subtitlesVisible) {
    document.getElementById('subtitle-overlay').innerHTML = '';
    lastSubtitleText = '';
  }
}

// 重试加载
function retryLoad() {
  location.reload();
}

// 加载YouTube API
function loadYouTubeAPI() {
  return new Promise((resolve, reject) => {
    if (window.YT && window.YT.Player) {
      resolve();
      return;
    }
    
    if (document.querySelector('script[src*="youtube.com/iframe_api"]')) {
      const checkAPI = setInterval(() => {
        if (window.YT && window.YT.Player) {
          clearInterval(checkAPI);
          resolve();
        }
      }, 100);
      
      setTimeout(() => {
        clearInterval(checkAPI);
        reject(new Error('YouTube API 加载超时'));
      }, 6000);
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://www.youtube.com/iframe_api';
    script.async = true;
    
    script.onload = () => {
      console.log('YouTube API 脚本加载成功');
    };
    
    script.onerror = () => {
      reject(new Error('YouTube API 脚本加载失败'));
    };
    
    document.head.appendChild(script);
    
    setTimeout(() => {
      reject(new Error('YouTube API 初始化超时'));
    }, 6000);
  });
}

// 初始化页面
async function initializePage() {
  try {
    currentVideoId = getVideoIdFromUrl();
    
    if (!currentVideoId) {
      throw new Error('未提供视频ID');
    }
    
    console.log('视频ID:', currentVideoId);
    updateLoadingStatus('加载视频信息...');
    
    // 并行加载标题和字幕
    const [title] = await Promise.all([
      fetchVideoTitle(currentVideoId),
      loadSubtitles(currentVideoId)
    ]);
    
    // 更新页面标题
    document.getElementById('video-title').textContent = title;
    document.title = `${title} - 视频播放`;
    
    updateLoadingStatus('尝试YouTube API...');
    console.log('加载 YouTube API...');
    
    try {
      await loadYouTubeAPI();
      // API加载成功，但播放器初始化由回调处理
      setTimeout(() => {
        // 如果3秒内API播放器还没初始化，直接用嵌入播放器
        if (playerType === 'none') {
          console.log('API初始化超时，直接使用嵌入播放器');
          tryEmbedPlayer();
        }
      }, 3000);
    } catch (apiError) {
      console.warn('YouTube API 加载失败:', apiError.message);
      // API加载失败，直接使用嵌入播放器
      tryEmbedPlayer();
    }
    
  } catch (error) {
    console.error('初始化页面失败:', error);
    showError(error.message);
  }
}

// 页面卸载清理
window.addEventListener('beforeunload', () => {
  if (updateInterval) {
    clearInterval(updateInterval);
  }
  if (loadingTimeout) {
    clearTimeout(loadingTimeout);
  }
  if (player && typeof player.destroy === 'function') {
    try {
      player.destroy();
    } catch (e) {
      console.warn('销毁播放器时出错:', e);
    }
  }
});

// 设置全局回调
window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
  console.log('页面DOM加载完成');
  
  initializePage();
  
  // 事件监听器
  document.getElementById('subtitle-toggle').addEventListener('click', toggleSubtitles);
  
  // 键盘快捷键
  document.addEventListener('keydown', (e) => {
    if ((e.key === 's' || e.key === 'S') && subtitles.length > 0) {
      e.preventDefault();
      toggleSubtitles();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      window.location.href = 'index.html';
    }
  });
});
</script>

</body>
</html>