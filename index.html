<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>视频分享主页 - 分批加载和分屏显示</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    background: #f0f2f5;
    height: 100vh;
    display: flex;
  }
  #sidebar {
    width: 280px;
    background: #fff;
    border-right: 1px solid #ddd;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #sidebar h2 {
    margin-top: 0;
    font-weight: 700;
    color: #333;
    border-bottom: 2px solid #1890ff;
    padding-bottom: 8px;
    margin-bottom: 16px;
    font-size: 22px;
  }
  #sidebar section {
    margin-bottom: 30px;
  }
  #sidebar section strong {
    display: block;
    margin-bottom: 10px;
    font-size: 16px;
    color: #555;
  }
  #sidebar ul {
    list-style: none;
    padding-left: 0;
  }
  #sidebar li {
    margin-bottom: 8px;
    cursor: pointer;
    color: #1890ff;
    font-weight: 500;
    user-select: none;
  }
  #sidebar li:hover {
    text-decoration: underline;
  }
  #sidebar li.active {
    font-weight: 700;
    color: #0050b3;
  }

  #main-content {
    flex: 1;
    padding: 20px 30px;
    box-sizing: border-box;
    overflow-y: auto;
    background: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  h1 {
    margin: 0 0 20px 0;
    font-weight: 700;
    color: #222;
  }

  #filter {
    padding: 10px 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }
  #filter:focus {
    border-color: #1890ff;
    outline: none;
  }

  #video-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    flex: 1;
  }

  .video-item {
    background: #fafafa;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    display: flex;
    flex-direction: column;
    height: fit-content;
  }

  iframe {
    width: 100%;
    aspect-ratio: 16 / 9;
    border: none;
  }

  .video-title {
    padding: 8px 12px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .video-date {
    padding: 0 12px 8px 12px;
    font-size: 12px;
    color: #999;
  }

  #loading {
    text-align: center;
    margin: 20px 0;
    color: #666;
    display: none;
  }

  #error {
    text-align: center;
    margin: 20px;
    padding: 15px;
    background: #fff2f0;
    border: 1px solid #ffccc7;
    border-radius: 6px;
    color: #a8071a;
    display: none;
  }

  /* 手机端单栏 */
  @media (max-width: 768px) {
    #video-grid {
      grid-template-columns: 1fr;
    }
    body {
      flex-direction: column;
    }
    #sidebar {
      width: 100%;
      height: auto;
      max-height: 200px;
    }
  }
</style>
</head>
<body>

<aside id="sidebar">
  <h2>分类导航</h2>
  <section>
    <strong>按年分类</strong>
    <ul id="yearList">
      <!-- 年份将动态生成 -->
    </ul>
  </section>
  <section>
    <strong>按月分类</strong>
    <ul id="monthList">
      <!-- 月份将动态生成 -->
    </ul>
  </section>
  <section>
    <strong>按标签分类</strong>
    <ul id="tagList">
      <!-- 标签将动态生成 -->
    </ul>
  </section>
</aside>

<main id="main-content">
  <h1>视频分享主页</h1>
  <input type="text" id="filter" placeholder="输入关键词过滤视频..." autocomplete="off" />
  <div id="video-grid"></div>
  <div id="loading">加载中...</div>
  <div id="error">数据加载失败，请稍后重试</div>
</main>

<script>
// 视频数据配置 - 你只需要修改这个文件就能更新视频
let allVideos = [];
const batchSize = 15;   
const displayStep = 12; 
let filteredVideos = [];
let loadedBatches = 0;  
let displayedCount = 0; 

const filterInput = document.getElementById('filter');
const videoGrid = document.getElementById('video-grid');
const loading = document.getElementById('loading');
const errorDiv = document.getElementById('error');
const mainContent = document.getElementById('main-content');

// 从外部JSON文件加载视频数据
async function loadVideoData() {
  try {
    // 尝试加载 videos.json 文件
    const response = await fetch('./videos.json');
    if (!response.ok) {
      throw new Error('无法加载视频数据');
    }
    const data = await response.json();
    allVideos = data.videos || [];
    filteredVideos = [...allVideos];
    
    // 动态生成分类导航
    generateCategories();
    
    // 开始显示视频
    resetAndLoad();
  } catch (error) {
    console.error('加载视频数据失败:', error);
    // 如果加载失败，使用示例数据
    loadFallbackData();
  }
}

// 备用示例数据
function loadFallbackData() {
  allVideos = [];
  for(let i=1; i<=50; i++) {
    allVideos.push({
      id: "dQw4w9WgXcQ",
      title: "示例视频 #" + i,
      date: "2025-08-0" + ((i % 5) + 1),
      tags: ["示例", i % 3 === 0 ? "热门" : "普通"],
      description: "这是示例视频的描述"
    });
  }
  filteredVideos = [...allVideos];
  generateCategories();
  resetAndLoad();
}

// 动态生成分类导航
function generateCategories() {
  const years = [...new Set(allVideos.map(v => v.date?.substring(0, 4)).filter(Boolean))].sort().reverse();
  const months = [...new Set(allVideos.map(v => v.date?.substring(5, 7)).filter(Boolean))].sort();
  const tags = [...new Set(allVideos.flatMap(v => v.tags || []))].sort();

  // 生成年份导航
  const yearList = document.getElementById('yearList');
  yearList.innerHTML = years.map(year => 
    `<li data-filter="${year}">${year}年</li>`
  ).join('');

  // 生成月份导航
  const monthList = document.getElementById('monthList');
  const monthNames = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
  monthList.innerHTML = months.map(month => {
    const monthNum = parseInt(month);
    return `<li data-filter="${month}">${monthNames[monthNum-1]}</li>`;
  }).join('');

  // 生成标签导航
  const tagList = document.getElementById('tagList');
  tagList.innerHTML = tags.map(tag => 
    `<li data-filter="${tag}">${tag}</li>`
  ).join('');
}

function createVideoItem(video) {
  const div = document.createElement('div');
  div.className = 'video-item';
  
  // 格式化日期
  const dateStr = video.date ? new Date(video.date).toLocaleDateString('zh-CN') : '';
  
  div.innerHTML = `
    <iframe src="https://www.youtube.com/embed/${video.id}" allowfullscreen></iframe>
    <div class="video-title" title="${video.displayTitle || video.title || '加载中...'}">${video.displayTitle || video.title || '加载中...'}</div>
    ${dateStr ? `<div class="video-date">${dateStr}</div>` : ''}
  `;
  
  // 如果还没有获取到真实标题，就去获取
  if (!video.displayTitle) {
    fetchYouTubeTitle(video.id).then(realTitle => {
      if (realTitle) {
        video.displayTitle = realTitle;
        const titleElement = div.querySelector('.video-title');
        if (titleElement) {
          titleElement.textContent = realTitle;
          titleElement.title = realTitle;
        }
      }
    });
  }
  
  return div;
}

// 获取 YouTube 视频真实标题
async function fetchYouTubeTitle(videoId) {
  try {
    // 使用 YouTube oEmbed API 获取视频信息
    const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
    if (response.ok) {
      const data = await response.json();
      return data.title;
    }
  } catch (error) {
    console.warn(`无法获取视频 ${videoId} 的标题:`, error);
  }
  return null;
}

function loadNextBatch() {
  loading.style.display = 'block';
  return new Promise(resolve => {
    setTimeout(() => {
      loadedBatches++;
      loading.style.display = 'none';
      resolve();
    }, 300);
  });
}

function showMoreVideos() {
  const totalLoadedVideos = loadedBatches * batchSize;
  if(displayedCount >= filteredVideos.length) return;
  if(displayedCount >= totalLoadedVideos) return;

  const nextCount = Math.min(displayedCount + displayStep, totalLoadedVideos, filteredVideos.length);
  for(let i=displayedCount; i<nextCount; i++) {
    videoGrid.appendChild(createVideoItem(filteredVideos[i]));
  }
  displayedCount = nextCount;
}

function resetAndLoad() {
  videoGrid.innerHTML = "";
  loadedBatches = 0;
  displayedCount = 0;
  if (filteredVideos.length === 0) {
    videoGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">没有找到相关视频</div>';
    return;
  }
  loadNextBatch().then(() => {
    showMoreVideos();
  });
}

// 搜索过滤
filterInput.addEventListener('input', () => {
  const text = filterInput.value.trim().toLowerCase();
  filteredVideos = allVideos.filter(v => 
    (v.title && v.title.toLowerCase().includes(text)) ||
    (v.displayTitle && v.displayTitle.toLowerCase().includes(text)) ||
    (v.description && v.description.toLowerCase().includes(text)) ||
    (v.tags && v.tags.some(tag => tag.toLowerCase().includes(text)))
  );
  clearActiveNav();
  resetAndLoad();
});

function clearActiveNav() {
  document.querySelectorAll('#sidebar li.active').forEach(li => li.classList.remove('active'));
}

function onCategoryClick(type, value, element) {
  if (type === "year") {
    filteredVideos = allVideos.filter(v => v.date && v.date.startsWith(value));
  } else if (type === "month") {
    filteredVideos = allVideos.filter(v => v.date && v.date.substring(5, 7) === value);
  } else if (type === "tag") {
    filteredVideos = allVideos.filter(v => v.tags && v.tags.includes(value));
  }
  
  filterInput.value = "";
  clearActiveNav();
  element.classList.add('active');
  resetAndLoad();
}

// 事件监听
document.getElementById('yearList').addEventListener('click', e => {
  if(e.target.tagName === 'LI') {
    onCategoryClick('year', e.target.dataset.filter, e.target);
  }
});
document.getElementById('monthList').addEventListener('click', e => {
  if(e.target.tagName === 'LI') {
    onCategoryClick('month', e.target.dataset.filter, e.target);
  }
});
document.getElementById('tagList').addEventListener('click', e => {
  if(e.target.tagName === 'LI') {
    onCategoryClick('tag', e.target.dataset.filter, e.target);
  }
});

// 滚动加载
mainContent.addEventListener('scroll', () => {
  const scrollTop = mainContent.scrollTop;
  const scrollHeight = mainContent.scrollHeight;
  const clientHeight = mainContent.clientHeight;
  
  if (scrollTop + clientHeight >= scrollHeight - 100) {
    if(displayedCount >= loadedBatches * batchSize && displayedCount < filteredVideos.length) {
      loadNextBatch().then(showMoreVideos);
    } else {
      showMoreVideos();
    }
  }
});

// 页面加载完成后开始
loadVideoData();
</script>

</body>
</html>